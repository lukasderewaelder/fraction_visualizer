<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruch-Visualisierer & Quiz</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #cbd5e1;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Controls */
        .sidebar {
            width: 360px;
            background-color: var(--surface);
            padding: 1.5rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            z-index: 10;
        }

        h1 { font-size: 1.4rem; margin: 0; color: var(--primary); }

        /* Tabs */
        .tabs {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
            gap: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 0.6rem;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #64748b;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .panel { display: none; flex-direction: column; gap: 1.2rem; }
        .panel.active { display: flex; }

        .control-group { display: flex; flex-direction: column; gap: 0.4rem; }
        label { font-weight: 600; font-size: 0.85rem; color: #475569; }
        
        input[type="number"], input[type="text"], input[type="color"], select, input[type="file"] {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        input[type="file"] { background: white; font-size: 0.8rem; }
        input[type="color"] { height: 40px; cursor: pointer; padding: 2px; }

        /* Quiz Styles */
        .quiz-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .quiz-feedback {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            text-align: center;
        }
        .feedback-success { background: #dcfce7; color: #166534; }
        .feedback-error { background: #fee2e2; color: #991b1b; }

        /* Buttons */
        .btn-group { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
        button {
            border: none;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-check { background-color: var(--success); color: white; margin-top:0.5rem; }
        .btn-download { background-color: #10b981; color: white; }
        .btn-download.png { background-color: #f59e0b; }
        button:hover { opacity: 0.9; }

        /* Viewport */
        .viewport {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #canvas-wrapper {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: inline-block;
        }
        svg { display: block; }
        canvas { display: none; }
        .mode-switch { display: flex; gap: 1rem; margin-bottom: 0.5rem; background: #f1f5f9; padding: 0.5rem; border-radius: 6px; }
        .radio-label { display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; cursor: pointer; color: var(--text); }
        .radio-label input { width: auto; margin: 0; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 0.6rem; cursor: pointer; font-size: 0.9rem; }
        .error-msg { color: #ef4444; font-size: 0.8rem; margin-top: 0.2rem; display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>Bruch Visualizer</h1>
        
        <div class="tabs">
            <div class="tab-btn active" onclick="switchMode('workshop')">Werkstatt</div>
            <div class="tab-btn" onclick="switchMode('quiz')">Quiz</div>
        </div>

        <!-- WORKSHOP PANEL -->
        <div id="panel-workshop" class="panel active">
            <div class="control-group">
                <label>Eingabe-Modus</label>
                <div class="mode-switch">
                    <label class="radio-label"><input type="radio" name="inputMode" value="standard" checked onchange="toggleInputMode()"> Standard</label>
                    <label class="radio-label"><input type="radio" name="inputMode" value="text" onchange="toggleInputMode()"> Text</label>
                </div>
            </div>

            <div id="input-standard">
                <div class="control-group">
                    <label>Z√§hler (Teile)</label>
                    <input type="number" id="numerator" value="3" min="0">
                </div>
                <div class="control-group" style="margin-top: 0.5rem;">
                    <label>Nenner (Teilung)</label>
                    <input type="number" id="denominator" value="4" min="1">
                </div>
            </div>

            <div id="input-text" style="display: none;">
                <div class="control-group">
                    <label>Bruch eingeben</label>
                    <input type="text" id="fractionText" placeholder="z.B. 5/7, 9/3 oder 2 1/2">
                    <div id="textError" class="error-msg">Ung√ºltiges Format</div>
                </div>
            </div>

            <div class="control-group">
                <label>Mindestanzahl Ganze</label>
                <input type="number" id="minWholes" value="1" min="1">
            </div>

            <label class="checkbox-wrapper">
                <input type="checkbox" id="randomize">
                <span>Zuf√§llig verteilen</span>
            </label>
            
            <div class="btn-group">
                 <button class="btn-primary" onclick="draw()">Neu Zeichnen</button>
            </div>
        </div>

        <!-- QUIZ PANEL -->
        <div id="panel-quiz" class="panel">
            <div class="quiz-card">
                <p style="margin:0 0 0.5rem 0; font-weight:600; color:#475569;">Frage:</p>
                <p style="margin:0; font-size:0.95rem;">Welcher Bruch ist dargestellt?</p>
            </div>

            <div class="control-group">
                <label>Deine Antwort</label>
                <input type="text" id="quizInput" placeholder="z.B. 3/4 oder 1 1/2" onkeypress="handleQuizEnter(event)">
                <button class="btn-check" onclick="checkQuizAnswer()">Antwort pr√ºfen</button>
            </div>

            <div id="quizFeedback" class="quiz-feedback"></div>

            <button class="btn-primary" onclick="generateQuizQuestion()">N√§chste Frage</button>
        </div>

        <!-- WORKSHOP ONLY CONTROLS -->
        <div id="workshop-controls">
            <hr style="width:100%; border:0; border-top:1px solid var(--border); margin:1rem 0;">
            
            <div class="control-group">
                <label>Darstellungsform</label>
                <select id="shapeType">
                    <option value="circle">Kreis (Farbe)</option>
                    <option value="polygon">Polygon</option>
                    <option value="rect">Rechteck</option>
                    <option value="pizza">Pizza</option>
                    <option value="circle-img">Kreis (Eigenes Bild)</option>
                </select>
            </div>

            <!-- Dynamic Options -->
            <div class="control-group" id="imgOptions" style="display:none">
                <label id="imgLabel">Bild ausw√§hlen</label>
                <input type="file" id="imgUpload" accept="image/*">
            </div>
            <div class="control-group" id="rectOptions" style="display: none;">
                <label>Rechteck-Teilung</label>
                <select id="gridDimensions"></select>
            </div>
            <div class="control-group" id="colorOption">
                <label>F√ºllfarbe</label>
                <input type="color" id="fillColor" value="#2563eb">
            </div>
            <div class="control-group">
                <label>Hintergrund</label>
                <div class="checkbox-wrapper" style="margin-bottom: 0.5rem;">
                    <input type="checkbox" id="bgTransparent" checked onchange="toggleBgColor()">
                    <span>Transparent</span>
                </div>
                <input type="color" id="bgColor" value="#e2e8f0" disabled>
            </div>

            <div class="btn-group" style="margin-top: 1rem;">
                <button class="btn-download" onclick="downloadSVG()">SVG Download</button>
                <button class="btn-download png" onclick="downloadPNG()">PNG Download</button>
            </div>
        </div>
    </div>

    <div class="viewport">
        <div id="canvas-wrapper">
            <svg id="mainSvg" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
    </div>

    <canvas id="exportCanvas"></canvas>

    <script>
        // --- STATE ---
        let currentMode = 'workshop'; // 'workshop' or 'quiz'
        let quizState = { n: 0, d: 1, isRand: false, type: 'circle', color: '#2563eb', rectGrid: '1x1' };
        let uploadedImgData = null;
        let defaultPizzaData = null;
        
        const NS = "http://www.w3.org/2000/svg";
        const svg = document.getElementById('mainSvg');
        const colors = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#db2777', '#0891b2'];
        const shapes = ['circle', 'polygon', 'rect', 'pizza'];

        // --- ELEMENTS ---
        const elNum = document.getElementById('numerator');
        const elDen = document.getElementById('denominator');
        const elFractionText = document.getElementById('fractionText');
        const elType = document.getElementById('shapeType');
        const elColor = document.getElementById('fillColor');
        const elGrid = document.getElementById('gridDimensions');
        const elWorkshopControls = document.getElementById('workshop-controls');

        // --- INIT ---
        initDefaultPizza();
        updateGridOptions();
        updateUI();

        // --- TABS & MODES ---
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[mode === 'workshop' ? 0 : 1].classList.add('active');
            
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${mode}`).classList.add('active');
            
            // Toggle shared controls visibility
            elWorkshopControls.style.display = mode === 'workshop' ? 'block' : 'none';

            if (mode === 'quiz') {
                generateQuizQuestion();
            } else {
                draw(); // Redraw manual state
            }
        }

        // --- QUIZ LOGIC ---
        function generateQuizQuestion() {
            // 1. Numbers
            const d = Math.floor(Math.random() * 11) + 2;
            const maxParts = Math.ceil(d * 2.5);
            const n = Math.floor(Math.random() * maxParts) + 1;
            const isRand = Math.random() < 0.3;

            // 2. Random Appearance
            const type = shapes[Math.floor(Math.random() * shapes.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // 3. Random Grid for Rect
            let rectGrid = '1x1';
            if (type === 'rect') {
                const factors = [];
                for(let i=1; i<=d; i++) if(d%i===0) factors.push(i);
                const rows = factors[Math.floor(Math.random() * factors.length)];
                rectGrid = `${rows}x${d/rows}`;
            }

            quizState = { n, d, isRand, type, color, rectGrid };
            
            // Reset UI
            document.getElementById('quizInput').value = '';
            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('quizInput').focus();
            
            draw();
        }

        function checkQuizAnswer() {
            const input = document.getElementById('quizInput').value;
            const feedback = document.getElementById('quizFeedback');
            const parsed = parseFractionString(input);

            if (!parsed || parsed.d === 0) {
                feedback.className = 'quiz-feedback feedback-error';
                feedback.innerHTML = 'Ung√ºltiges Format.<br><small>Versuche z.B. "3/4" oder "1 1/2"</small>';
                feedback.style.display = 'block';
                return;
            }

            // Compare Values: n1/d1 == n2/d2  => n1*d2 == n2*d1
            const valUser = parsed.n * quizState.d;
            const valQuiz = quizState.n * parsed.d;

            if (valUser === valQuiz) {
                feedback.className = 'quiz-feedback feedback-success';
                feedback.innerHTML = 'Richtig! üéâ';
            } else {
                feedback.className = 'quiz-feedback feedback-error';
                // Show correct answer in simple form
                const correctMixed = toMixedString(quizState.n, quizState.d);
                feedback.innerHTML = `Leider falsch.<br>L√∂sung: <b>${quizState.n}/${quizState.d}</b>${correctMixed ? ' oder ' + correctMixed : ''}`;
            }
            feedback.style.display = 'block';
        }

        function handleQuizEnter(e) {
            if (e.key === 'Enter') checkQuizAnswer();
        }

        function toMixedString(n, d) {
            if (n < d) return null;
            const whole = Math.floor(n / d);
            const rem = n % d;
            if (rem === 0) return `${whole}`;
            return `${whole} ${rem}/${d}`;
        }

        // --- DRAWING ENGINE ---
        function getDrawParams() {
            if (currentMode === 'quiz') {
                return {
                    n: quizState.n,
                    d: quizState.d,
                    isRand: quizState.isRand,
                    minW: 1,
                    type: quizState.type,
                    color: quizState.color,
                    rectGrid: quizState.rectGrid,
                    emptyColor: 'none' // Transparent in quiz
                };
            } else {
                // Workshop Mode
                const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
                let n = 0, d = 1;
                
                if (inputMode === 'standard') {
                    n = parseInt(elNum.value) || 0;
                    d = parseInt(elDen.value) || 1;
                    document.getElementById('textError').style.display = 'none';
                } else {
                    const parsed = parseFractionString(elFractionText.value);
                    if (parsed && parsed.d > 0) {
                        n = parsed.n; d = parsed.d;
                        document.getElementById('textError').style.display = 'none';
                        updateGridOptions(d);
                    } else {
                        document.getElementById('textError').style.display = 'block';
                        return null; 
                    }
                }
                
                const bgTrans = document.getElementById('bgTransparent').checked;
                
                return {
                    n: n,
                    d: d,
                    isRand: document.getElementById('randomize').checked,
                    minW: parseInt(document.getElementById('minWholes').value) || 1,
                    type: elType.value,
                    color: elColor.value,
                    rectGrid: elGrid.value,
                    emptyColor: bgTrans ? "none" : document.getElementById('bgColor').value
                };
            }
        }

        function draw() {
            const params = getDrawParams();
            if (!params) { svg.innerHTML = ''; return; }

            const { n, d, isRand, minW, type, color, rectGrid, emptyColor } = params;
            
            const wholesNeeded = Math.max(minW, Math.ceil(n / d));
            
            // Layout Calculation
            const cellSize = 240;
            const cols = Math.ceil(Math.sqrt(wholesNeeded));
            const rows = Math.ceil(wholesNeeded / cols);
            
            svg.setAttribute("width", cols * cellSize);
            svg.setAttribute("height", rows * cellSize);
            svg.innerHTML = '';

            // Randomization Logic
            let indices = Array.from({length: wholesNeeded * d}, (_, i) => i);
            if (isRand) {
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
            }
            const activeIndices = new Set(indices.slice(0, n));

            // Render Wholes
            for (let i = 0; i < wholesNeeded; i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const g = document.createElementNS(NS, "g");
                g.setAttribute("transform", `translate(${col * cellSize + cellSize/2}, ${row * cellSize + cellSize/2})`);
                
                const localActive = [];
                for(let j=0; j<d; j++) {
                    if (activeIndices.has(i * d + j)) localActive.push(j);
                }

                renderShape(g, type, d, localActive, color, emptyColor, i, rectGrid);
                svg.appendChild(g);
            }
        }

        // --- EVENT LISTENERS UI ---
        document.getElementById('numerator').addEventListener('input', draw);
        document.getElementById('denominator').addEventListener('input', () => { updateGridOptions(); draw(); });
        document.getElementById('fractionText').addEventListener('input', draw);
        document.getElementById('minWholes').addEventListener('input', draw);
        document.getElementById('randomize').addEventListener('change', draw);
        document.getElementById('fillColor').addEventListener('input', draw);
        document.getElementById('bgColor').addEventListener('input', draw);
        
        elType.addEventListener('change', () => { updateUI(); draw(); });
        
        document.getElementById('imgUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(evt){ uploadedImgData = evt.target.result; draw(); };
                reader.readAsDataURL(file);
            } else {
                uploadedImgData = null; draw();
            }
        });

        // --- HELPER FUNCTIONS ---
        function toggleInputMode() {
            const mode = document.querySelector('input[name="inputMode"]:checked').value;
            document.getElementById('input-standard').style.display = mode === 'standard' ? 'block' : 'none';
            document.getElementById('input-text').style.display = mode === 'text' ? 'block' : 'none';
            draw();
        }
        
        function toggleBgColor() {
            const isTrans = document.getElementById('bgTransparent').checked;
            document.getElementById('bgColor').disabled = isTrans;
            draw();
        }

        function updateUI() {
            const val = elType.value;
            document.getElementById('rectOptions').style.display = val === 'rect' ? 'flex' : 'none';
            const imgOpts = document.getElementById('imgOptions');
            const colOpts = document.getElementById('colorOption');
            
            if (val === 'circle-img' || val === 'pizza') {
                imgOpts.style.display = 'flex';
                document.getElementById('imgLabel').textContent = val === 'pizza' ? 'Anderes Bild w√§hlen (Optional)' : 'Bild ausw√§hlen';
                colOpts.style.display = 'none';
            } else {
                imgOpts.style.display = 'none';
                colOpts.style.display = 'flex';
            }
        }

        function updateGridOptions(forceDenom) {
            const d = forceDenom || parseInt(elDen.value) || 1;
            elGrid.innerHTML = '';
            for (let i = 1; i <= d; i++) {
                if (d % i === 0) {
                    const opt = document.createElement('option');
                    opt.value = `${i}x${d/i}`;
                    opt.text = `${i} Zeilen x ${d/i} Spalten`;
                    if (Math.abs(i - d/i) <= 1) opt.selected = true;
                    elGrid.appendChild(opt);
                }
            }
        }

        function parseFractionString(str) {
            str = str.trim();
            if (!str) return null;
            // Mixed: "2 1/2"
            const mixedMatch = str.match(/^(\d+)\s+(\d+)\s*\/\s*(\d+)$/);
            if (mixedMatch) return { n: parseInt(mixedMatch[1]) * parseInt(mixedMatch[3]) + parseInt(mixedMatch[2]), d: parseInt(mixedMatch[3]) };
            // Simple: "5/7"
            const simpleMatch = str.match(/^(\d+)\s*\/\s*(\d+)$/);
            if (simpleMatch) return { n: parseInt(simpleMatch[1]), d: parseInt(simpleMatch[2]) };
            // Whole: "3"
            const wholeMatch = str.match(/^(\d+)$/);
            if (wholeMatch) return { n: parseInt(wholeMatch[1]), d: 1 };
            return null;
        }

        function initDefaultPizza() {
            const canvas = document.createElement('canvas');
            canvas.width = 400; canvas.height = 400;
            const ctx = canvas.getContext('2d');
            const cx = 200, cy = 200, r = 190;
            // Draw Pizza
            ctx.fillStyle = "#d97706"; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#fef3c7"; ctx.beginPath(); ctx.arc(cx, cy, r - 20, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#b91c1c"; 
            [[120, 120], [280, 120], [120, 280], [280, 280], [200, 100], [200, 300], [100, 200], [300, 200], [200, 200]].forEach(p => {
                ctx.beginPath(); ctx.arc(p[0], p[1], 25, 0, Math.PI*2); ctx.fill();
            });
            defaultPizzaData = canvas.toDataURL();
            draw();
        }

        // --- RENDER SHAPE LOGIC ---
        function renderShape(group, type, d, activeList, fillColor, emptyColor, wholeId, rectGrid) {
            const r = 90;
            if (type === 'circle-img' || type === 'pizza') {
                let imgSrc = uploadedImgData || (type === 'pizza' ? defaultPizzaData : null);
                if (!imgSrc) {
                    group.appendChild(createSVG('text', { x: 0, y: 0, "text-anchor": "middle", "dominant-baseline": "middle", fill: "#94a3b8", "font-size": "14" }, "Bild w√§hlen"));
                    group.appendChild(createSVG('circle', { r: r, fill: "none", stroke: "#cbd5e1", "stroke-width": 2, "stroke-dasharray": "4 4" }));
                    return;
                }
                
                let activePathD = "";
                activeList.forEach(i => activePathD += getSectorPath(0, 0, r, d, i));

                const clipId = `clip-${wholeId}-${Math.random().toString(36).substr(2,9)}`;
                const defs = document.createElementNS(NS, "defs");
                const clipPath = document.createElementNS(NS, "clipPath");
                clipPath.setAttribute("id", clipId);
                if (activePathD) clipPath.appendChild(createSVG("path", { d: activePathD }));
                defs.appendChild(clipPath);
                group.appendChild(defs);

                if (activePathD) {
                    const img = document.createElementNS(NS, "image");
                    img.setAttributeNS(null, "href", imgSrc);
                    img.setAttribute("width", r*2); img.setAttribute("height", r*2);
                    img.setAttribute("x", -r); img.setAttribute("y", -r);
                    img.setAttribute("preserveAspectRatio", "xMidYMid slice");
                    img.setAttribute("clip-path", `url(#${clipId})`);
                    group.appendChild(img);
                }

                for(let i=0; i<d; i++) {
                    if(!activeList.includes(i) && emptyColor !== 'none') {
                        group.appendChild(createSVG('path', { d: getSectorPath(0, 0, r, d, i), fill: emptyColor, stroke: "none" }));
                    }
                    group.appendChild(createSVG('path', { d: getSectorPath(0, 0, r, d, i), fill: "none", stroke: "#334", "stroke-width": 2 }));
                }
                return;
            }

            // VECTOR SHAPES
            for (let i = 0; i < d; i++) {
                const isFilled = activeList.includes(i);
                const fill = isFilled ? fillColor : emptyColor;
                if (type === 'circle') {
                    if (d === 1) group.appendChild(createSVG('circle', { r: r, fill: fill, stroke: "#334", "stroke-width": 2 }));
                    else group.appendChild(createSVG('path', { d: getSectorPath(0, 0, r, d, i), fill: fill, stroke: "#334", "stroke-width": 2 }));
                } else if (type === 'rect') {
                    const [rows, cols] = rectGrid ? rectGrid.split('x').map(Number) : [1, d];
                    const w = 180 / cols, h = 180 / rows;
                    const rI = Math.floor(i / cols), cI = i % cols;
                    group.appendChild(createSVG('rect', { x: -90 + cI*w, y: -90 + rI*h, width: w, height: h, fill: fill, stroke: "#334", "stroke-width": 2 }));
                } else if (type === 'polygon') {
                    const sides = Math.max(3, d);
                    const step = (Math.PI * 2) / sides;
                    const s = -Math.PI / 2 + i * step;
                    const x1 = r * Math.cos(s), y1 = r * Math.sin(s);
                    const x2 = r * Math.cos(s+step), y2 = r * Math.sin(s+step);
                    group.appendChild(createSVG('path', { d: `M 0 0 L ${x1} ${y1} L ${x2} ${y2} Z`, fill: fill, stroke: "#334", "stroke-width": 2 }));
                }
            }
        }

        function getSectorPath(cx, cy, r, d, i) {
             const step = (Math.PI * 2) / d;
             const s = -Math.PI / 2 + i * step;
             const e = s + step;
             return `M ${cx} ${cy} L ${cx + r * Math.cos(s)} ${cy + r * Math.sin(s)} A ${r} ${r} 0 ${step > Math.PI ? 1:0} 1 ${cx + r * Math.cos(e)} ${cy + r * Math.sin(e)} Z`;
        }

        function createSVG(tag, attrs, textContent) {
            const el = document.createElementNS(NS, tag);
            for (let k in attrs) el.setAttribute(k, attrs[k]);
            if(textContent) el.textContent = textContent;
            return el;
        }

        function downloadSVG() {
            const blob = new Blob([new XMLSerializer().serializeToString(svg)], {type: "image/svg+xml;charset=utf-8"});
            triggerDownload(URL.createObjectURL(blob), "bruch.svg");
        }

        function downloadPNG() {
            const canvas = document.getElementById('exportCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            const url = URL.createObjectURL(new Blob([new XMLSerializer().serializeToString(svg)], {type: 'image/svg+xml;charset=utf-8'}));
            img.onload = function() {
                canvas.width = svg.width.baseVal.value; canvas.height = svg.height.baseVal.value;
                ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);
                triggerDownload(canvas.toDataURL("image/png"), "bruch.png");
            };
            img.src = url;
        }

        function triggerDownload(url, name) {
            const a = document.createElement("a"); a.href = url; a.download = name; a.click();
        }
    </script>
</body>
</html>
